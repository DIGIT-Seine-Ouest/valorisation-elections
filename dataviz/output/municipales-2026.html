<ods-dataset-context context="resultatsmunicipales2026, bureauxdevoteelectoraux2026, limitedecommune" 
    resultatsmunicipales2026-dataset="resultats-municipales-2026"
    resultatsmunicipales2026-parameters="{'sort':'nom_quartier'}"
    bureauxdevoteelectoraux2026-dataset="bureaux-de-vote-electoraux-2026" 
    bureauxdevoteelectoraux2026-parameters="{'disjunctive.nom_bureau':true,'disjunctive.num_bureau':true}" 
    limitedecommune-dataset="limite-de-commune">
    <section class="container-fluid">
        <header class="app-header">
    <h1 class="app-title">Municipales 2026</h1>
</header>
        <div class="result-detailed">
            <div class="sidebar">
    <!-- SCRIPT SANS AFFICHAGE -->
    <span ng-init="bdvquartiers = [];"></span>
    <!-- Récupération des quartiers uniques -->
    <span ods-results="items"
            ods-results-context="resultatsmunicipales2026"
            ods-results-max="500">
        <!-- Boucler sur le Dataset -->
        <span ng-repeat="item in items">
            <!-- Intégrer les données uniques dans bdvCode -->
            <span ng-if="bdvquartiers.indexOf(item.fields.nom_quartier) === -1">
                {{ bdvquartiers.push(item.fields.nom_quartier) && item.fields.nom_quartier }}
            </span>
        </span>
    </span>
    <!-- FIN SCRIPT -->

    <!-- Afficher les datas -->
    <div class="filter-title">Les quartiers</div>
    <!-- Lister les lieux de votes -->
     <ul class="filter-list">
        <li class="filter-item">
            <span class="station-num" style="background:var(--text-dark); color:white;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg></span>
            Clear filter
        </li>
        <li class="filter-item" ng-repeat="quartier in bdvquartiers">
            <span class="station-num">{{ $index + 1 }}</span> &nbsp; {{ quartier }}
        </li>
    </ul>
</div>
            <div class="content-maps">
    <ods-dataset-context context="bureauxdevoteelectoraux2026,limitedecommune" bureauxdevoteelectoraux2026-dataset="bureaux-de-vote-electoraux-2026" bureauxdevoteelectoraux2026-parameters="{'disjunctive.nom_bureau':true,'disjunctive.num_bureau':true}" limitedecommune-dataset="limite-de-commune">
        <ods-map no-refit="false" scroll-wheel-zoom="false" basemap="jawg.light" style="height: 100%;">
                <ods-map-layer 
                    context="bureauxdevoteelectoraux2026" 
                    color="rgb(101, 167, 11)" 
                    picto="dot" 
                    show-marker="false" 
                    refine-on-click-context="ctxrefine"
                    display="auto"></ods-map-layer>
    
                <ods-map-layer 
                    context="limitedecommune" 
                    color="#AAAAAA" 
                    picto="ods-circle" 
                    show-marker="true" 
                    display="auto" 
                    shape-opacity="0.3" 
                    point-opacity="1" 
                    border-color="#19630A"
                    border-opacity="1" 
                    border-size="3" 
                    border-pattern="solid" 
                    caption-picto-color="#E5E5E5" 
                    size="4" size-min="3" size-max="5" size-function="linear"></ods-map-layer>
        </ods-map>
    
    </ods-dataset-context>
</div>
            <div class="detail-panel">
    <div class="panel-header animate-fade">
        <div class="panel-context">Résultats de la ville entière</div>
        <h2 class="panel-title">Meudon (Total)</h2>
    </div>
    <div class="panel-body">
        <!-- Partie résulats d'aggregations -->
        <div class="stats-grid-main">
            <!-- Afficher le nombre d'inscrits -->
            <div class="stat-card-main">
                <span 
                    class="val-main"
                    ods-aggregation="statInscrits"
                    ods-aggregation-context="resultatsmunicipales2026"
                    ods-aggregation-expression="nb_inscrits"
                    ods-aggregation-function="SUM">
                    {{ statInscrits | number }}
                </span>
                <span class="lbl-main">Inscrits</span>
            </div>

            <!-- Afficher le nombre de votants  -->
            <div class="stat-card-main">
                <span 
                    class="val-main"
                    ods-aggregation="statVotants"
                    ods-aggregation-context="resultatsmunicipales2026"
                    ods-aggregation-expression="nb_votants"
                    ods-aggregation-function="SUM">
                    {{ statVotants | number }}
                </span>
                <span class="lbl-main">Votants</span>
            </div>

            <!-- Calculer le taux de participation -->
            <div class="stat-card-main" style="border-color:var(--green-primary);">

                <!-- Calcul sophistiqué à faire -->
                <!-- Récupérer les chiffres nb_inscrits -->
                 <span 
                    class="val-main"
                    ods-aggregation="statInscrits"
                    ods-aggregation-context="resultatsmunicipales2026"
                    ods-aggregation-expression="nb_inscrits"
                    ods-aggregation-function="SUM">
                    <!-- Récupérer les chiffres nb_votants -->
                    <span 
                        class="val-main"
                        ods-aggregation="statVotants"
                        ods-aggregation-context="resultatsmunicipales2026"
                        ods-aggregation-expression="nb_votants"
                        ods-aggregation-function="SUM">

                        <!-- Juste l'affichage des données -->
                        <span class="val-main" style="color:var(--green-primary);">
                            {{ (statVotants / statInscrits)*100 | number:2 }} %
                        </span>

                    </span>
                </span>
                <span class="lbl-main">Participation</span>
            </div>

        </div>
    
        <div class="stats-grid-sub">
            <!-- Calculer nombre de voix exprimé -->
            <div class="stat-card-sub highlight-stat">
                <span 
                    class="val-main"
                    ods-aggregation="statVotants"
                    ods-aggregation-context="resultatsmunicipales2026"
                    ods-aggregation-expression="nb_votants"
                    ods-aggregation-function="SUM">
                    
                    <span 
                        class="val-sub"
                        ods-aggregation="statNul"
                        ods-aggregation-context="resultatsmunicipales2026"
                        ods-aggregation-expression="nb_nuls"
                        ods-aggregation-function="SUM">
                    
                        <span 
                            class="val-sub"
                            ods-aggregation="statBlanc"
                            ods-aggregation-context="resultatsmunicipales2026"
                            ods-aggregation-expression="nb_blanc"
                            ods-aggregation-function="SUM">
                            {{ statVotants - (statNul + statBlanc) | number }}
                        </span>
                    </span>
                </span>
                <span class="lbl-sub">Exprimés</span>
            </div>

            <!-- Afficher le nb d'abstention -->
            <div class="stat-card-sub">
                <span 
                    class="val-sub"
                    ods-aggregation="nbAbstentions"
                    ods-aggregation-context="resultatsmunicipales2026"
                    ods-aggregation-expression="nb_abstentions"
                    ods-aggregation-function="SUM">
                    {{ nbAbstentions | number }}
                </span>
                <span class="lbl-sub">Abstentions</span>
            </div>

            <!-- Afficher le nb de null -->
            <div class="stat-card-sub">
                <span 
                    class="val-sub"
                    ods-aggregation="statBlanc"
                    ods-aggregation-context="resultatsmunicipales2026"
                    ods-aggregation-expression="nb_blanc"
                    ods-aggregation-function="SUM">
                    {{ statBlanc | number }}
                </span>
                <span class="lbl-sub">Blancs</span>
            </div>

            <!-- Afficher les nuls -->
            <div class="stat-card-sub">
                <span 
                    class="val-sub"
                    ods-aggregation="statNul"
                    ods-aggregation-context="resultatsmunicipales2026"
                    ods-aggregation-expression="nb_nuls"
                    ods-aggregation-function="SUM">
                    {{ statNul | number }}
                </span>
                <span class="lbl-sub">Nuls</span>
            </div>
        </div>

        <!-- Partie résultats filtrée ou pas. -->
        <h4 style="margin-bottom:15px; color:var(--text-dark); font-size:14px; font-weight:700; text-transform:uppercase;">Résultats détaillé</h4>
        <!-- Faire une boucle ICI  -->
        <div 
            ods-results="items"
            ods-results-context="resultatsmunicipales2026" 
            ods-results-max="500">
            <div class="res-item" ng-repeat="item in items">
                <div class="res-header">
                    <span class="res-name">Meudon Écologie</span>
                    <span style="font-weight:bold; color:var(--text-dark);">15.54%</span>
                </div>
                <div class="progress-track">
                    <div class="progress-bar c-1" style="width: 15.54%"></div>
                </div>
                <div style="font-size:11px; color:#888; margin-top:3px; text-align:right;">2 794 voix</div>
            </div>
        </div>
    </div>
</div>
        </div>
    </section>
</ods-dataset-context>