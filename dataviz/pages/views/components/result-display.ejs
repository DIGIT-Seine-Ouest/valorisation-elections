<div class="detail-panel">
    <div class="panel-header animate-fade" ng-if="!resultatsmunicipales2026.parameters['refine.num_bureau']">
        <div class="panel-context">Résultats de la ville entière</div>
        <h2 class="panel-title">Meudon (Total)</h2>
    </div>
    <div class="panel-header animate-fade" ng-if="resultatsmunicipales2026.parameters['refine.num_bureau']">
        <div class="panel-context">BUREAU N°{{resultatsmunicipales2026.parameters['refine.num_bureau']}}</div>
            <h2 class="panel-title" ods-adv-analysis="myData"
                ods-adv-analysis-context="resultatsmunicipales2026"
                ods-adv-analysis-select="nom_bureau">
                {{myData[0].nom_bureau }}
            </h2>
    </div>
    <div class="panel-body">
        <!-- Partie résulats d'aggregations -->
        <div class="stats-grid-main">
            <!-- Afficher le nombre d'inscrits -->
            <div class="stat-card-main">
                <span class="val-main"
                    ods-analysis="Inscrits"
                    ods-analysis-context="resultatsmunicipales2026"
                    ods-analysis-x="liste"
                    ods-analysis-serie-inscrits="SUM(nb_inscrits)">
                    {{Inscrits["results"][0].inscrits | number}}
                </span>
                <span class="lbl-main">Inscrits</span>
            </div>

            <!-- Afficher le nombre de votants  -->
            <div class="stat-card-main">
                <span class="val-main"
                    ods-analysis="Votants"
                    ods-analysis-context="resultatsmunicipales2026"
                    ods-analysis-x="liste"
                    ods-analysis-serie-votants="SUM(nb_votants)">
                    {{Votants["results"][0].votants | number}}
                </span>
                <span class="lbl-main">Votants</span>
            </div>

            <!-- Calculer le taux de participation -->
            <div class="stat-card-main" style="border-color:var(--green-primary);">
                 <span class="val-main" style="color:var(--green-primary);" 
                    ods-adv-analysis="voteParticipation"
                    ods-adv-analysis-context="resultatsmunicipales2026"
                    ods-adv-analysis-select="(sum(nb_votants) / sum(nb_inscrits)) * 100 as participation"
                    ods-adv-analysis-group-by="liste">
                    {{ voteParticipation[0].participation | number:2 }} %
                </span>
                </span>
                <span class="lbl-main">Participation</span>
            </div>

        </div>
    
        <div class="stats-grid-sub">
            <!-- Calculer nombre de voix exprimé -->
            <div class="stat-card-sub highlight-stat">
                <div class="val-sub"
                    ods-adv-analysis="votesExprimes"
                    ods-adv-analysis-context="resultatsmunicipales2026"
                    ods-adv-analysis-select="sum(nb_votants) - ( sum(nb_nuls) + sum(nb_blanc) ) as total_votes_exprimes"
                    ods-adv-analysis-group-by="liste">
                    {{ votesExprimes[0].total_votes_exprimes | number }}
                </div>
                <span class="lbl-sub">Exprimés</span>
            </div>

            <!-- Afficher le nb d'abstention -->
            <div class="stat-card-sub">
                <span 
                    class="val-sub"
                    ods-analysis="Abstentions"
                    ods-analysis-context="resultatsmunicipales2026"
                    ods-analysis-x="liste"
                    ods-analysis-serie-abstentions="SUM(nb_abstentions)">
                    {{Abstentions["results"][0].abstentions | number}}
                </span>
                <span class="lbl-sub">Abstentions</span>
            </div>

            <!-- Afficher le nb de null -->
            <div class="stat-card-sub">
                <span 
                    class="val-sub"
                    ods-analysis="Blancs"
                    ods-analysis-context="resultatsmunicipales2026"
                    ods-analysis-x="liste"
                    ods-analysis-serie-blanc="SUM(nb_blanc)">
                    {{Blancs["results"][0].blanc | number}}
                </span>
                <span class="lbl-sub">Blancs</span>
            </div>

            <!-- Afficher les nuls -->
            <div class="stat-card-sub">
                <span 
                    class="val-sub"
                    ods-analysis="Nuls"
                    ods-analysis-context="resultatsmunicipales2026"
                    ods-analysis-x="liste"
                    ods-analysis-serie-nuls="SUM(nb_nuls)">
                    {{Nuls["results"][0].nuls | number}}
                </span>
                <span class="lbl-sub">Nuls</span>
            </div>
        </div>

        <!-- Partie résultats filtrée ou pas. -->
        <h4 style="margin-bottom:15px; color:var(--text-dark); font-size:14px; font-weight:700; text-transform:uppercase;">Résultats</h4>
        <!-- Faire une boucle ICI  -->
        <div ods-analysis="candidats"
            ods-analysis-context="resultatsmunicipales2026"
            ods-analysis-x="liste"
            ods-analysis-serie-nombre="SUM(nombre_de_voies)"
            ods-analysis-sort="nombre">
            <div class="res-item" ng-repeat="candidat in candidats['results']">

                <div class="res-header">
                    <span class="res-name">{{candidat.x}}</span>
                    <span style="font-weight:bold; color:var(--text-dark);">
                        <span 
                            ods-adv-analysis="votesExprimes"
                            ods-adv-analysis-context="resultatsmunicipales2026"
                            ods-adv-analysis-select="sum(nb_votants) - ( sum(nb_nuls) + sum(nb_blanc) ) as total_votes_exprimes"
                            ods-adv-analysis-group-by="liste">
                            {{ (candidat.nombre / votesExprimes[0].total_votes_exprimes) * 100 | number:2 }} %
                        </span>
                    </span>
                </div>

                <div ods-adv-analysis="votesExprimes"
                    ods-adv-analysis-context="resultatsmunicipales2026"
                    ods-adv-analysis-select="sum(nb_votants) - ( sum(nb_nuls) + sum(nb_blanc) ) as total_votes_exprimes"
                    ods-adv-analysis-group-by="liste">
                    <div class="progress-track">
                        <div class="progress-bar c-1" 
                            style="width: {{ (candidat.nombre / votesExprimes[0].total_votes_exprimes) * 100 }}%">
                        </div>
                    </div>
                    
                </div>
                <div style="font-size:11px; color:#888; margin-top:3px; text-align:right;">
                    {{candidat.nombre | number }} voix
                </div>
            </div>
        </div>
    </div>
</div>